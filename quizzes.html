<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SGS Coaching | Interactive Quiz Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta name="description" content="Interactive quiz portal at SGS Coaching. Chapterwise and midterm quizzes with rankings and instant analytics.">
  <meta name="robots" content="index,follow">
  <link rel="canonical" href="https://sgscoaching.github.io/sgs-coaching-website/quizzes.html">
  <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com">
  <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #2c3e50;
      position: relative;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 1000"><polygon fill="%23ffffff" fill-opacity="0.03" points="0,1000 1000,1000 1000,0 0,400"/></svg>');
      z-index: -1;
    }

    /* Live Ticker Bar */
    .live-ticker-bar {
      background: linear-gradient(135deg, #fbbf24, #f59e0b);
      color: white;
      padding: 0.65rem 0;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      box-shadow: 0 2px 10px rgba(0,0,0,0.15);
      overflow: hidden;
    }
    
    /* Adjust body padding to account for fixed ticker */
    body.has-ticker {
      padding-top: 40px;
    }

    .ticker-container {
      display: flex;
      align-items: center;
      gap: 1rem;
      white-space: nowrap;
      overflow: hidden;
      position: relative;
    }

    .ticker-label {
      background: rgba(255,255,255,0.2);
      padding: 0.35rem 0.9rem;
      border-radius: 20px;
      font-weight: 700;
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      gap: 0.4rem;
      flex-shrink: 0;
      animation: pulse 2s ease-in-out infinite;
      z-index: 2;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.8; }
    }

    .ticker-wrapper {
      display: flex;
      gap: 2rem;
      flex: 1;
      overflow: hidden;
    }

    .ticker-content {
      display: flex;
      gap: 2rem;
      animation: scrollTicker 40s linear infinite;
    }

    #tickerContentDuplicate {
      animation: scrollTicker 40s linear infinite;
    }

    .ticker-wrapper:hover .ticker-content,
    .ticker-wrapper:hover #tickerContentDuplicate {
      animation-play-state: paused;
    }

    @keyframes scrollTicker {
      0% { transform: translateX(0); }
      100% { transform: translateX(-100%); }
    }

    .ticker-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.9rem;
      flex-shrink: 0;
    }

    .ticker-item.rank1 {
      font-weight: 700;
      color: #fef3c7;
    }
    
    .ticker-item.recent {
      color: #e0e7ff;
      font-style: italic;
    }

    .ticker-medal {
      font-size: 1rem;
    }

    /* Congratulations Modal */
    .congrats-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      backdrop-filter: blur(5px);
      z-index: 10000;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.3s ease-out;
    }

    .congrats-modal.show {
      display: flex;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .congrats-content {
      background: linear-gradient(135deg, #fef3c7, #fde68a);
      border-radius: 24px;
      padding: 3rem 2.5rem;
      max-width: 500px;
      width: 90%;
      text-align: center;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      animation: scaleIn 0.4s ease-out;
      border: 4px solid #fbbf24;
      position: relative;
    }

    @keyframes scaleIn {
      from { transform: scale(0.8); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }

    .congrats-icon {
      font-size: 5rem;
      margin-bottom: 1rem;
      animation: bounce 1s ease-in-out infinite;
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-15px); }
    }

    .congrats-title {
      font-size: 2.2rem;
      font-weight: 800;
      color: #92400e;
      margin-bottom: 1rem;
    }

    .congrats-message {
      font-size: 1.2rem;
      color: #78350f;
      margin-bottom: 1.5rem;
      line-height: 1.6;
    }

    .congrats-btn {
      background: linear-gradient(135deg, #3b82f6, #1d4ed8);
      color: white;
      border: none;
      padding: 1rem 2.5rem;
      border-radius: 50px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
    }

    .congrats-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 25px rgba(59, 130, 246, 0.4);
    }

    /* Navigation */
    .nav-header {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(15px);
      padding: 1rem 0;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      position: sticky;
      top: 40px;
      z-index: 999;
    }
    
    body.has-ticker .nav-header {
      top: 40px;
    }

    .nav-container {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 2rem;
    }

    .logo-section {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .logo-section img {
      width: 45px;
      height: 45px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(45, 140, 240, 0.3);
    }

    .logo-text {
      font-size: 1.4rem;
      font-weight: 700;
      background: linear-gradient(135deg, #2d8cf0, #1e3a8a);
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .home-btn {
      background: linear-gradient(135deg, #2d8cf0, #1e3a8a);
      color: white;
      padding: 0.7rem 1.5rem;
      border-radius: 25px;
      text-decoration: none;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(45, 140, 240, 0.3);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .home-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 25px rgba(45, 140, 240, 0.4);
    }

    /* Main Container */
    .quiz-container {
      max-width: 900px;
      margin: 2rem auto;
      padding: 0 1rem;
    }

    /* Hero Section */
    .quiz-hero {
      text-align: center;
      margin-bottom: 2rem;
      padding: 2rem;
    }

    .quiz-hero h1 {
      font-size: 3rem;
      font-weight: 800;
      color: white;
      margin-bottom: 1rem;
      text-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }

    .quiz-hero .highlight {
      background: linear-gradient(135deg, #ffeaa7, #fab1a0);
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .quiz-hero p {
      font-size: 1.2rem;
      color: rgba(255,255,255,0.9);
      margin-bottom: 1rem;
    }

    /* Floating characters like home hero */
    .quiz-floating {
      position: fixed;
      border-radius: 999px;
      background: rgba(255,255,255,0.12);
      box-shadow: 0 10px 40px rgba(15,23,42,0.25);
      backdrop-filter: blur(8px);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.8rem;
      color: #fefcbf;
      animation: quizFloat 9s ease-in-out infinite;
      z-index: 1;
      pointer-events: none;
    }

    .quiz-floating.student {
      width: 70px;
      height: 70px;
      top: 18%;
      right: 8%;
      animation-delay: 0s;
    }

    .quiz-floating.book {
      width: 60px;
      height: 60px;
      bottom: 18%;
      left: 6%;
      animation-delay: 1.8s;
    }

    .quiz-floating.light {
      width: 60px;
      height: 60px;
      bottom: 30%;
      right: 18%;
      animation-delay: 3.2s;
    }

    @keyframes quizFloat {
      0%, 100% { transform: translateY(0) translateX(0); }
      25% { transform: translateY(-10px) translateX(4px); }
      50% { transform: translateY(0) translateX(8px); }
      75% { transform: translateY(8px) translateX(-4px); }
    }

    /* Quiz Card */
    .quiz-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: 24px;
      padding: 2.5rem;
      box-shadow: 0 20px 60px rgba(0,0,0,0.1);
      border: 1px solid rgba(255,255,255,0.3);
      transition: all 0.3s ease;
    }

    .quiz-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 30px 80px rgba(0,0,0,0.15);
    }

    /* Student Form */
    .student-form {
      text-align: center;
      margin-bottom: 2rem;
    }

    .form-title {
      font-size: 1.8rem;
      font-weight: 700;
      color: #2c3e50;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .form-subtitle {
      color: #64748b;
      margin-bottom: 2rem;
      font-size: 1.1rem;
    }

    .form-group {
      margin-bottom: 1.5rem;
      text-align: left;
    }

    .form-group label {
      display: block;
      font-weight: 600;
      color: #374151;
      margin-bottom: 0.5rem;
      font-size: 0.95rem;
    }

    .form-input {
      width: 100%;
      padding: 1rem 1.2rem;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      font-size: 1rem;
      transition: all 0.3s ease;
      background: #fafafa;
    }

    .form-input:focus {
      outline: none;
      border-color: #3b82f6;
      background: white;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .error-message {
      color: #ef4444;
      font-size: 0.9rem;
      margin-top: 0.5rem;
      display: none;
      padding: 0.5rem;
      background: #fef2f2;
      border-radius: 8px;
      border-left: 4px solid #ef4444;
    }

    /* Buttons */
    .btn-primary {
      background: linear-gradient(135deg, #3b82f6, #1d4ed8);
      color: white;
      padding: 1rem 2rem;
      border: none;
      border-radius: 50px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      width: 100%;
      justify-content: center;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
    }

    /* Dropdowns */
    .dropdowns {
      display: none;
      margin-bottom: 2rem;
    }

    .dropdown-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .dropdown-group {
      position: relative;
    }

    .dropdown-label {
      display: block;
      font-weight: 600;
      color: #374151;
      margin-bottom: 0.5rem;
      font-size: 0.95rem;
    }

    .dropdown-select {
      width: 100%;
      padding: 1rem 1.2rem;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      font-size: 1rem;
      background: #fafafa;
      cursor: pointer;
      transition: all 0.3s ease;
      appearance: none;
      background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="%236b7280"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>');
      background-repeat: no-repeat;
      background-position: right 1rem center;
      background-size: 1rem;
      padding-right: 3rem;
    }

    .dropdown-select:focus {
      outline: none;
      border-color: #3b82f6;
      background: white;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    /* Quiz Area */
    .quiz-area {
      display: none;
    }

    .quiz-header {
      background: linear-gradient(135deg, #f8fafc, #e2e8f0);
      padding: 1.5rem;
      border-radius: 16px;
      margin-bottom: 2rem;
      border: 1px solid #e2e8f0;
    }

    .quiz-title-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .quiz-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: #1e293b;
      margin: 0;
    }

    .timer-display {
      background: linear-gradient(135deg, #3b82f6, #1d4ed8);
      color: white;
      padding: 0.75rem 1.5rem;
      border-radius: 50px;
      font-size: 1.1rem;
      font-weight: 700;
      box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
      display: flex;
      align-items: center;
      gap: 0.5rem;
      position: sticky;
      top: 80px;
      z-index: 100;
      width: fit-content;
      margin: 0 auto 1rem;
    }
    
    /* Mobile timer visibility */
    @media (max-width: 768px) {
      .timer-display {
        position: fixed;
        top: 70px;
        right: 10px;
        padding: 0.5rem 1rem;
        font-size: 0.9rem;
        z-index: 1000;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      }
    }

    /* Questions */
    .question {
      background: white;
      border-radius: 16px;
      padding: 2rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 4px 15px rgba(0,0,0,0.05);
      border: 1px solid #e5e7eb;
      transition: all 0.3s ease;
    }

    .question:hover {
      box-shadow: 0 8px 25px rgba(59, 130, 246, 0.1);
      border-color: #bfdbfe;
    }

    .question-text {
      font-size: 1.1rem;
      font-weight: 600;
      color: #1e293b;
      margin-bottom: 1.5rem;
      line-height: 1.6;
    }

    .options {
      display: grid;
      gap: 1rem;
    }

    .option-item {
      display: flex;
      align-items: center;
      padding: 1rem 1.25rem;
      margin: 0.5rem 0;
      background-color: #f9fafb;
      border: 2px solid #e5e7eb;
      border-radius: 0.5rem;
      cursor: pointer;
      transition: all 0.2s ease-in-out;
      position: relative;
      overflow: hidden;
    }
    
    .option-item:hover {
      background-color: #f3f4f6;
      border-color: #d1d5db;
    }
    
    .option-item input[type="radio"] {
      display: none; /* Hide the default radio button */
    }
    
    .option-item.selected {
      background-color: #ecfdf5;
      border-color: #10b981;
      color: #064e3b;
    }
    
    .option-item.selected .option-text::before {
      content: "‚úì";
      display: inline-block;
      width: 1.25rem;
      height: 1.25rem;
      margin-right: 0.75rem;
      background-color: #10b981;
      color: white;
      border-radius: 50%;
      text-align: center;
      line-height: 1.25rem;
      font-size: 0.75rem;
    }
    
    /* Correct answer (not selected by user) */
    .option-item.correct-answer {
      background-color: #d1fae5;
      border-color: #10b981;
      color: #064e3b;
    }
    
    /* Correct answer (selected by user) */
    .option-item.correct-answer.selected {
      background-color: #10b981;
      color: white;
      font-weight: 600;
    }
    
    /* Incorrect answer (selected by user) */
    .option-item.incorrect-answer {
      background-color: #fee2e2;
      border-color: #ef4444;
      color: #7f1d1d;
      text-decoration: line-through;
    }
    
    /* Fill in blank input styling */
    .fill-blank-container {
      margin: 1rem 0;
    }
    
    .fill-blank-input {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 1rem;
      margin: 0.5rem 0;
      transition: all 0.3s ease;
      background-color: white;
    }
    
    .fill-blank-input:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      outline: none;
    }
    
    .fill-blank-input.correct {
      background-color: #d1fae5;
      border-color: #10b981;
      color: #064e3b;
      font-weight: 500;
    }
    
    .fill-blank-input.incorrect {
      background-color: #fee2e2;
      border-color: #ef4444;
      color: #7f1d1d;
      text-decoration: line-through;
    }
    
    .correct-answer-text {
      display: block;
      margin: 0.5rem 0 1rem 0;
      padding: 0.75rem 1rem;
      background-color: #ecfdf5;
      border: 1px solid #a7f3d0;
      border-radius: 8px;
      color: #064e3b;
      font-weight: 500;
      font-size: 0.95rem;
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-5px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Results */
    .result-display {
      background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
      border-radius: 16px;
      padding: 2rem;
      margin-top: 2rem;
      border: 1px solid #bae6fd;
      text-align: center;
    }

    .result-score {
      font-size: 2rem;
      font-weight: 800;
      color: #0c4a6e;
      margin-bottom: 1rem;
    }

    .result-details {
      color: #075985;
      font-size: 1.1rem;
      margin-bottom: 1.5rem;
    }

    /* Rankings */
    .ranking-section {
      display: none;
      margin-top: 2rem;
      background: linear-gradient(135deg, #fefce8, #fef3c7);
      border-radius: 16px;
      padding: 2rem;
      border: 1px solid #fde047;
    }

    .ranking-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: #92400e;
      margin-bottom: 1.5rem;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .user-rank {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      border: 2px solid #fbbf24;
      text-align: center;
    }

    .rank-number {
      font-size: 1.8rem;
      font-weight: 800;
      color: #92400e;
    }

    .top-rankers {
      display: grid;
      gap: 1rem;
    }

    .rank-item {
      background: white;
      border-radius: 12px;
      padding: 1rem 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-left: 4px solid #fbbf24;
      transition: all 0.3s ease;
    }

    .rank-item:hover {
      transform: translateX(5px);
      box-shadow: 0 4px 15px rgba(251, 191, 36, 0.2);
    }

    .rank-item.gold {
      border-left-color: #fbbf24;
      background: linear-gradient(135deg, #fffbeb, #fefce8);
    }

    .rank-item.silver {
      border-left-color: #9ca3af;
      background: linear-gradient(135deg, #f9fafb, #f3f4f6);
    }

    .rank-item.bronze {
      border-left-color: #d97706;
      background: linear-gradient(135deg, #fff7ed, #fed7aa);
    }

    /* Animations */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes pulse {
      0%, 100% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.05);
      }
    }

    .fade-in {
      animation: fadeInUp 0.6s ease-out;
    }

    .pulse {
      animation: pulse 2s infinite;
    }

    /* Loading */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(59, 130, 246, 0.3);
      border-radius: 50%;
      border-top-color: #3b82f6;
      animation: spin 1s ease-in-out infinite;
    }

        @keyframes spin {
          to { transform: rotate(360deg); }
        }

        @keyframes slideIn {
          from {
            transform: translateX(400px);
            opacity: 0;
          }
          to {
            transform: translateX(0);
            opacity: 1;
          }
        }

        @keyframes slideOut {
          from {
            transform: translateX(0);
            opacity: 1;
          }
          to {
            transform: translateX(400px);
            opacity: 0;
          }
        }

    /* Success States */
    .success-indicator {
      background: linear-gradient(135deg, #d1fae5, #a7f3d0);
      border: 1px solid #10b981;
      color: #064e3b;
      padding: 1rem;
      border-radius: 12px;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
      .live-ticker-bar {
        padding: 0.5rem 0;
        font-size: 0.8rem;
      }
      
      .ticker-label {
        font-size: 0.75rem;
        padding: 0.3rem 0.7rem;
      }
      
      .ticker-item {
        font-size: 0.8rem;
        gap: 0.3rem;
      }
      
      body.has-ticker {
        padding-top: 35px;
      }
      
      body.has-ticker .nav-header {
        top: 35px;
      }
      
      .quiz-container {
        padding: 0.5rem;
        margin: 1rem auto;
      }
      
      .card {
        border-radius: 12px;
        padding: 1rem;
      }
      
      .nav-container {
        padding: 0 1rem;
        flex-direction: column;
        gap: 1rem;
        text-align: center;
      }
      
      .logo-section {
        justify-content: center;
      }
      
      .question-text {
        font-size: 1.1rem;
        line-height: 1.4;
      }
      
      .option-item {
        padding: 0.8rem 1rem;
        font-size: 0.95rem;
      }
      
      .btn-primary, .home-btn {
        width: 100%;
        padding: 0.8rem;
        text-align: center;
        justify-content: center;
      }
      
      .timer-display {
        font-size: 0.9rem;
        padding: 0.5rem 1rem;
        position: fixed !important;
        top: 70px !important;
        right: 10px !important;
        z-index: 1000 !important;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3) !important;
        display: flex !important;
      }
      
      .quiz-header {
        padding-top: 60px; /* Add space for fixed timer */
      }
      
      .result-score {
        font-size: 2.5rem;
      }
      
      .result-details {
        font-size: 1rem;
      }
    }
    
    @media (max-width: 480px) {
      .question-text {
        font-size: 1rem;
        margin-bottom: 1rem;
      }
      
      .option-item {
        padding: 0.9rem 1rem;
        margin: 0.4rem 0;
        min-height: 3.5rem;
        display: flex;
        align-items: center;
      }
      
      .btn-primary, .home-btn {
        font-size: 1rem;
        padding: 1rem;
        margin: 0.5rem 0;
      }
      
      .fill-blank-input {
        font-size: 1rem;
        padding: 0.8rem 1rem;
        min-height: 3rem;
      }
      
      .dropdown-select {
        font-size: 0.95rem;
        padding: 0.8rem 2.5rem 0.8rem 1rem;
      }
      
      .quiz-title {
        font-size: 1.3rem;
      }
      
      .timer-display {
        font-size: 1rem;
        padding: 0.4rem 0.8rem;
      }
    }
    
    @media (max-width: 768px) {
      .quiz-hero h1 {
        font-size: 2rem;
      }
      
      .quiz-card {
        padding: 1.5rem;
      }
      
      .dropdown-grid {
        grid-template-columns: 1fr;
      }
      
      .quiz-title-row {
        flex-direction: column;
        text-align: center;
      }

      .quiz-floating {
        display: none;
      }
      
      .nav-container {
        padding: 0 1rem;
      }
      
      .quiz-container {
        padding: 0 0.5rem;
      }
    }

    /* Progress Bar */
    .progress-container {
      background: #e5e7eb;
      border-radius: 10px;
      height: 8px;
      margin-bottom: 2rem;
      overflow: hidden;
    }

    .progress-bar {
      background: linear-gradient(135deg, #10b981, #059669);
      height: 100%;
      width: 0%;
      transition: width 0.5s ease;
      border-radius: 10px;
    }

    /* Floating elements */
    .floating-stats {
      position: fixed;
      top: 50%;
      right: 2rem;
      transform: translateY(-50%);
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      padding: 1rem;
      border-radius: 12px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
      font-size: 0.9rem;
      z-index: 50;
      display: none;
    }

    @media (max-width: 1024px) {
      .floating-stats {
        display: none !important;
      }
    }
  </style>
</head>
<body>
  <div class="quiz-floating student">üßë‚Äçüéì</div>
  <div class="quiz-floating book">üìò</div>
  <div class="quiz-floating light">üí°</div>
  
  <!-- Live Ticker Bar -->
  <div class="live-ticker-bar" id="liveTickerBar" style="display: none;">
    <div class="ticker-container">
      <div class="ticker-label">
        <i class="fas fa-fire"></i>
        Live Activity
      </div>
      <div class="ticker-wrapper">
        <div class="ticker-content" id="tickerContent">
          <!-- Ticker items will be populated by JavaScript -->
        </div>
        <!-- Duplicate content for seamless loop -->
        <div class="ticker-content" id="tickerContentDuplicate">
          <!-- Duplicate ticker items -->
        </div>
      </div>
    </div>
  </div>

  <!-- Congratulations Modal -->
  <div class="congrats-modal" id="congratsModal">
    <div class="congrats-content">
      <div class="congrats-icon">üèÜ</div>
      <h2 class="congrats-title">Congratulations!</h2>
      <p class="congrats-message" id="congratsMessage">
        You've achieved <strong>Rank #1</strong>! üéâ<br>
        Outstanding performance! Keep up the excellent work and continue to excel in your studies!
      </p>
      <button class="congrats-btn" onclick="closeCongratsModal()">Awesome!</button>
    </div>
  </div>

  <!-- Navigation -->
  <div class="nav-header">
    <div class="nav-container">
      <div class="logo-section">
        <img src="Logo.png" alt="SGS Coaching Logo" loading="eager" fetchpriority="high" onerror="this.style.display='none'">
        <div class="logo-text">SGS Coaching</div>
      </div>
      <a href="index.html" class="home-btn">
        <i class="fas fa-home"></i>
        Back to Home
      </a>
    </div>
  </div>

  <!-- Main Container -->
  <div class="quiz-container">
    <!-- Hero Section -->
    <div class="quiz-hero fade-in">
      <h1>üß† Interactive <span class="highlight">Quiz Portal</span></h1>
      <p>Test your knowledge, track your progress, and compete with fellow students!</p>
      <div style="margin-top: 1.5rem; display: flex; gap: 2rem; justify-content: center; flex-wrap: wrap; font-size: 0.95rem; color: rgba(255,255,255,0.9);">
        <div style="display: flex; align-items: center; gap: 0.5rem;">
          <i class="fas fa-users" style="font-size: 1.2rem;"></i>
          <span><strong id="totalParticipants">193+</strong> Students Participated</span>
        </div>
        <div style="display: flex; align-items: center; gap: 0.5rem;">
          <i class="fas fa-trophy" style="font-size: 1.2rem;"></i>
          <span>Live Rankings</span>
        </div>
        <div style="display: flex; align-items: center; gap: 0.5rem;">
          <i class="fas fa-redo" style="font-size: 1.2rem;"></i>
          <span>Retake Anytime</span>
        </div>
      </div>
    </div>

    <!-- Quiz Card -->
    <div class="quiz-card fade-in">
      <!-- Student Info Form -->
      <form id="studentInfoForm" class="student-form">
        <div class="form-title">
          <i class="fas fa-user-graduate"></i>
          Welcome to Quiz Portal
        </div>
        <p class="form-subtitle">Enter your details to start your learning journey</p>
        
        <!-- Notification Permission Banner -->
        <div id="notificationBanner" style="display: none; background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 1rem; border-radius: 12px; margin-bottom: 1.5rem; text-align: center; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);">
          <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem;">
            <div style="flex: 1; text-align: left;">
              <strong style="display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-bell"></i> Get Daily Quiz Reminders!
              </strong>
              <div style="font-size: 0.85rem; opacity: 0.95; margin-top: 0.3rem;">
                Stay motivated with daily notifications about new quizzes and your progress
              </div>
            </div>
            <button type="button" id="enableNotificationsBtn" style="background: white; color: #059669; border: none; padding: 0.7rem 1.5rem; border-radius: 25px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
              <i class="fas fa-check"></i> Enable
            </button>
          </div>
        </div>
        
        <div id="infoError" class="error-message"></div>
        
        <div class="form-group">
          <label for="nameInput">Full Name</label>
          <input type="text" id="nameInput" class="form-input" placeholder="Enter your full name" required>
        </div>

        <div class="form-group">
          <label for="mobileInput">Mobile Number</label>
          <input type="tel" id="mobileInput" class="form-input" placeholder="Enter 10-digit mobile number" maxlength="10" pattern="[0-9]{10}" required>
        </div>

        <button type="submit" class="btn-primary">
          <i class="fas fa-rocket"></i>
          Start Quiz Journey
        </button>
      </form>

      <!-- Subject Selection -->
      <div class="dropdowns" style="display: none;">
        <!-- Quiz Statistics Banner -->
        <div id="quizStatsBanner" style="display: none; background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; padding: 1rem; border-radius: 12px; margin-bottom: 1.5rem; text-align: center; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);">
          <div style="font-size: 0.9rem; opacity: 0.95;">
            <i class="fas fa-chart-line"></i> 
            <span id="availableQuizzesCount">0</span> new quizzes available | 
            <span id="completedQuizzesCount">0</span> completed
          </div>
        </div>
        
        <div class="dropdown-grid">
          <div class="dropdown-group" id="classDropdownGroup">
            <label class="dropdown-label">Select Class</label>
            <select id="classSelect" class="dropdown-select">
              <option value="">Choose your class...</option>
            </select>
          </div>
          <div class="dropdown-group" id="subjectDropdownGroup" style="display: none;">
            <label class="dropdown-label">Select Subject</label>
            <select id="subjectSelect" class="dropdown-select">
              <option value="">Choose subject...</option>
            </select>
          </div>
          <div class="dropdown-group" id="testTypeDropdownGroup" style="display: none;">
            <label class="dropdown-label">Select Test Type</label>
            <select id="testTypeSelect" class="dropdown-select">
              <option value="">Choose test type...</option>
              <option value="chapterwise">Chapterwise</option>
              <option value="midterm1">Mid Term 1</option>
              <option value="midterm2">Mid Term 2</option>
            </select>
          </div>
        </div>
        <div class="dropdown-grid">
          <div class="dropdown-group" id="chapterDropdownContainer" style="display: none; width: 100%;">
            <label class="dropdown-label">Select Chapter</label>
            <select id="chapterSelect" class="dropdown-select">
              <option value="">Choose quiz topic...</option>
            </select>
          </div>
          <div class="dropdown-group" id="midtermDropdownContainer" style="display: none; width: 100%;">
            <label class="dropdown-label">Select Test</label>
            <select id="midtermTestSelect" class="dropdown-select">
              <option value="">Choose sample test...</option>
            </select>
          </div>
        </div>
        <!-- Start Quiz Button -->
        <div id="startQuizButtonContainer" style="display: none; text-align: center; margin-top: 2rem;">
          <button id="startQuizBtn" class="btn-primary" style="padding: 1rem 3rem; font-size: 1.2rem;">
            <i class="fas fa-play"></i> Start Quiz
          </button>
        </div>
      </div>

      <!-- Quiz Area -->
      <div id="quizArea" class="quiz-area">
        <div class="quiz-header">
          <div class="quiz-title-row">
            <h2 id="quizTitle" class="quiz-title"></h2>
            <div class="timer-display">
              <i class="fas fa-clock"></i>
              <span id="timeDisplay">00:00</span>
            </div>
          </div>
        </div>

        <div class="progress-container">
          <div class="progress-bar" id="progressBar"></div>
        </div>

        <form id="quizForm"></form>
        <div id="result" class="result-display" style="display: none;"></div>
        
        <div id="rankingSection" class="ranking-section">
          <div class="ranking-title">
            <i class="fas fa-trophy"></i>
            Quiz Rankings
          </div>
          <div id="userRank" class="user-rank"></div>
          <div id="topRankers" class="top-rankers"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Floating Stats (Desktop) -->
  <div class="floating-stats" id="floatingStats">
    <div style="font-weight: 600; margin-bottom: 0.5rem;">Quiz Stats</div>
    <div>Questions: <span id="statQuestions">-</span></div>
    <div>Progress: <span id="statProgress">0%</span></div>
    <div>Time: <span id="statTime">00:00</span></div>
  </div>

  <script src="script.js" defer></script>
  <script src="midterm-questions.js" defer></script>
  <script src="google-sheets-api.js" defer></script>
  <script>
    // Global variables
    let currentStudentName = "";
    let currentStudentMobile = "";
    let currentQuiz = null;
    let quizStartTime = null;
    let quizTimer = null;
    let secondsElapsed = 0;
    let answeredQuestions = 0;
    let isShowingAlert = false; // Flag to prevent blur warnings during alerts

    // DOM elements
    const infoForm = document.getElementById('studentInfoForm');
    const infoError = document.getElementById('infoError');
    const dropdownsDiv = document.querySelector('.dropdowns');
    const classSelect = document.getElementById('classSelect');
    const subjectSelect = document.getElementById('subjectSelect');
    const subjectDropdownGroup = document.getElementById('subjectDropdownGroup');
    const testTypeSelect = document.getElementById('testTypeSelect');
    const testTypeDropdownGroup = document.getElementById('testTypeDropdownGroup');
    const chapterDropdownContainer = document.getElementById('chapterDropdownContainer');
    const chapterSelect = document.getElementById('chapterSelect');
    const midtermDropdownContainer = document.getElementById('midtermDropdownContainer');
    const midtermTestSelect = document.getElementById('midtermTestSelect');
    const startQuizButtonContainer = document.getElementById('startQuizButtonContainer');
    const quizArea = document.getElementById('quizArea');
    const quizForm = document.getElementById('quizForm');
    const quizTitle = document.getElementById('quizTitle');
    const resultDiv = document.getElementById('result');
    const timeDisplay = document.getElementById('timeDisplay');
    const rankingSection = document.getElementById('rankingSection');
    const userRank = document.getElementById('userRank');
    const topRankers = document.getElementById('topRankers');
    const progressBar = document.getElementById('progressBar');
    const floatingStats = document.getElementById('floatingStats');

    // Student form handler
    if (infoForm) {
      infoForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const nameInput = document.getElementById('nameInput');
        const mobileInput = document.getElementById('mobileInput');
        
        if (!nameInput || !mobileInput) {
          console.error('Form inputs not found');
          return;
        }
        
        const name = nameInput.value.trim();
        const mobile = mobileInput.value.trim();
        
        if (!name) {
          showError("Please enter your full name");
          return;
        }
        if (!mobile.match(/^[0-9]{10}$/)) {
          showError("Please enter a valid 10-digit mobile number");
          return;
        }
        
        hideError();
        currentStudentName = name;
        currentStudentMobile = mobile;
        
        // Success animation
        const successDiv = document.createElement('div');
        successDiv.className = 'success-indicator fade-in';
        successDiv.innerHTML = '<i class="fas fa-check"></i> Registration successful! Please select your quiz.';
        infoForm.parentNode.insertBefore(successDiv, infoForm.nextSibling);
        
        setTimeout(() => {
          infoForm.style.display = "none";
          successDiv.style.display = "none";
          
          // Show dropdowns section
          if (dropdownsDiv) {
            dropdownsDiv.style.display = "block";
            dropdownsDiv.classList.add('fade-in');
            
            // Refresh dropdowns to show only available quizzes
            if (classSelect.value) {
              populateSubjectDropdown();
            }
          }
          
          // Ensure only class dropdown is visible initially
          if (subjectDropdownGroup) subjectDropdownGroup.style.display = 'none';
          if (testTypeDropdownGroup) testTypeDropdownGroup.style.display = 'none';
          if (chapterDropdownContainer) chapterDropdownContainer.style.display = 'none';
          if (midtermDropdownContainer) midtermDropdownContainer.style.display = 'none';
          if (startQuizButtonContainer) startQuizButtonContainer.style.display = 'none';
          
          // Ensure class dropdown is populated and visible
          if (classSelect) {
            // Make sure class dropdown group is visible
            const classDropdownGroup = document.getElementById('classDropdownGroup');
            if (classDropdownGroup) {
              classDropdownGroup.style.display = 'block';
            }
            
            // Populate if needed
            if (classSelect.options.length <= 1) {
              populateClassDropdown();
            }
          }
          
          // Scroll to dropdowns after a small delay to ensure they're rendered
          setTimeout(() => {
            if (dropdownsDiv) {
              dropdownsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
          }, 100);
        }, 1500);
      });
    }

    function showError(message) {
      infoError.textContent = message;
      infoError.style.display = "block";
      infoError.classList.add('fade-in');
    }

    function hideError() {
      infoError.style.display = "none";
    }

    // ==================== NOTIFICATION SYSTEM ====================
    
    // Motivational notification messages
    const notificationMessages = [
      {
        title: "üéØ New Quiz Challenge Awaits!",
        body: "Test your knowledge today and climb the leaderboard! Your next quiz is waiting!",
        icon: "üß†"
      },
      {
        title: "‚ö° Boost Your Rank Today!",
        body: "Take a quick quiz now and see how you rank among 193+ students. Every quiz makes you better!",
        icon: "üèÜ"
      },
      {
        title: "üìö Practice Makes Perfect!",
        body: "Daily quiz practice is the key to success. Start your learning journey now!",
        icon: "‚ú®"
      },
      {
        title: "üöÄ You're Doing Great!",
        body: "Keep the momentum going! Take another quiz and improve your score even more!",
        icon: "üí™"
      },
      {
        title: "üéì Master Your Subjects!",
        body: "New quizzes are available for you. Challenge yourself and track your progress!",
        icon: "üìñ"
      },
      {
        title: "üåü Show Your Skills!",
        body: "Compete with other students and see where you stand. Your quiz adventure continues!",
        icon: "‚≠ê"
      },
      {
        title: "üî• Don't Miss Out!",
        body: "More students are joining daily. Stay ahead by practicing regularly with our quizzes!",
        icon: "üî•"
      },
      {
        title: "üí° Quick Practice Session?",
        body: "Just 10 minutes of quiz practice can boost your confidence! Start now!",
        icon: "‚ö°"
      }
    ];

    // Check if notifications are supported
    function checkNotificationSupport() {
      if (!("Notification" in window)) {
        console.log("This browser does not support notifications");
        return false;
      }
      return true;
    }

    // Request notification permission
    async function requestNotificationPermission() {
      if (!checkNotificationSupport()) {
        return false;
      }

      if (Notification.permission === "granted") {
        return true;
      }

      if (Notification.permission !== "denied") {
        const permission = await Notification.requestPermission();
        return permission === "granted";
      }

      return false;
    }

    // Show notification
    function showNotification(title, body, icon = "üß†") {
      if (!checkNotificationSupport() || Notification.permission !== "granted") {
        return;
      }

      const options = {
        body: body,
        icon: "Logo.png",
        badge: "Logo.png",
        tag: "quiz-reminder",
        requireInteraction: false,
        silent: false
      };

      try {
        const notification = new Notification(`${icon} ${title}`, options);
        
        // Auto close after 5 seconds
        setTimeout(() => {
          notification.close();
        }, 5000);

        // Handle click - redirect to quiz page
        notification.onclick = function() {
          window.focus();
          this.close();
          if (window.location.pathname !== '/quizzes.html' && window.location.pathname !== '/sgs web/quizzes.html') {
            window.location.href = "quizzes.html";
          }
        };
      } catch (error) {
        console.log("Error showing notification:", error);
      }
    }

    // Show random motivational notification
    function showMotivationalNotification() {
      const randomMessage = notificationMessages[Math.floor(Math.random() * notificationMessages.length)];
      showNotification(randomMessage.title, randomMessage.body, randomMessage.icon);
    }

    // Schedule daily notification check (when user visits the site)
    function scheduleDailyNotifications() {
      const notificationsEnabled = localStorage.getItem('notificationsEnabled') === 'true';
      if (!notificationsEnabled || Notification.permission !== 'granted') {
        return;
      }

      const lastNotification = localStorage.getItem('lastNotificationTime');
      const now = Date.now();
      const oneDay = 24 * 60 * 60 * 1000; // 24 hours

      if (!lastNotification || (now - parseInt(lastNotification)) >= oneDay) {
        setTimeout(() => {
          showMotivationalNotification();
          localStorage.setItem('lastNotificationTime', now.toString());
        }, 3000); // Wait 3 seconds after page load
      }
    }

    // Show notification banner if permission not granted
    function checkAndShowNotificationBanner() {
      const banner = document.getElementById('notificationBanner');
      if (!banner) return;

      const notificationsEnabled = localStorage.getItem('notificationsEnabled') === 'true';
      
      if (Notification.permission === 'granted' || (notificationsEnabled && Notification.permission !== 'denied')) {
        banner.style.display = 'none';
        return;
      }

      // Show banner if user has visited before (but not on first visit)
      const hasVisited = localStorage.getItem('hasVisitedQuizPage') === 'true';
      if (hasVisited && Notification.permission === 'default') {
        setTimeout(() => {
          banner.style.display = 'block';
        }, 2000);
      } else {
        localStorage.setItem('hasVisitedQuizPage', 'true');
      }
    }

    // Handle enable notifications button click
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        setupNotificationButton();
      });
    } else {
      setupNotificationButton();
    }

    function setupNotificationButton() {
      const enableBtn = document.getElementById('enableNotificationsBtn');
      const banner = document.getElementById('notificationBanner');
      
      if (enableBtn) {
        enableBtn.addEventListener('click', async function() {
          const granted = await requestNotificationPermission();
          if (granted) {
            localStorage.setItem('notificationsEnabled', 'true');
            if (banner) banner.style.display = 'none';
            
            // Show success message
            const successMsg = document.createElement('div');
            successMsg.style.cssText = 'position: fixed; top: 20px; right: 20px; background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 1rem 1.5rem; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 10000; animation: slideIn 0.3s ease-out; display: flex; align-items: center; gap: 0.5rem;';
            successMsg.innerHTML = '<i class="fas fa-check-circle"></i> <span>Notifications enabled! You\'ll receive daily quiz reminders.</span>';
            document.body.appendChild(successMsg);
            
            setTimeout(() => {
              successMsg.style.animation = 'slideOut 0.3s ease-out';
              setTimeout(() => successMsg.remove(), 300);
            }, 4000);

            // Show first notification after 5 seconds
            setTimeout(() => {
              showMotivationalNotification();
              localStorage.setItem('lastNotificationTime', Date.now().toString());
            }, 5000);
          } else if (Notification.permission === 'denied') {
            alert('Notifications were blocked. Please enable them in your browser settings to receive daily quiz reminders.');
          }
        });
      }
    }
    // ==================== END NOTIFICATION SYSTEM ====================

    // Timer functions
    function startTimer() {
      quizStartTime = Date.now();
      secondsElapsed = 0;
      floatingStats.style.display = 'block';
      quizTimer = setInterval(() => {
        secondsElapsed++;
        const minutes = Math.floor(secondsElapsed / 60);
        const seconds = secondsElapsed % 60;
        const timeStr = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        timeDisplay.textContent = timeStr;
        document.getElementById('statTime').textContent = timeStr;
      }, 1000);
    }

    function stopTimer() {
      if (quizTimer) {
        clearInterval(quizTimer);
        quizTimer = null;
      }
      floatingStats.style.display = 'none';
    }

    function updateProgress() {
      if (currentQuiz) {
        const progress = (answeredQuestions / currentQuiz.questions.length) * 100;
        progressBar.style.width = progress + '%';
        document.getElementById('statProgress').textContent = Math.round(progress) + '%';
      }
    }

    // Ranking functions
    function getQuizKey() {
      return `${currentQuiz.title}_${classSelect.value}_${subjectSelect.value}`;
    }

    // Get unique quiz identifier
    function getQuizIdentifier(classVal, subjectVal, testType, chapterOrTest) {
      if (testType === 'chapterwise') {
        const quizTitle = window.quizData[classVal][subjectVal][chapterOrTest]?.title || '';
        return `${classVal}_${subjectVal}_chapterwise_${quizTitle}`;
      } else if (testType === 'midterm1' || testType === 'midterm2') {
        return `${classVal}_${subjectVal}_${testType}_${chapterOrTest}`;
      }
      return `${classVal}_${subjectVal}_${testType}`;
    }

    // Get all completed quizzes for current student
    function getCompletedQuizzes() {
      if (!currentStudentName || !currentStudentMobile) return new Set();
      
      const completed = new Set();
      
      // Check local storage
      const localResults = JSON.parse(localStorage.getItem('quizResults') || '{}');
      Object.values(localResults).flat().forEach(result => {
        if (result.name === currentStudentName && result.mobile === currentStudentMobile && result.quizTitle) {
          completed.add(result.quizTitle);
        }
      });
      
      // Also check from Google Sheets data if available (we'll fetch this)
      return completed;
    }

    // Get completed quiz identifiers for current student
    async function getCompletedQuizIdentifiers() {
      if (!currentStudentName || !currentStudentMobile) return new Set();
      
      const completed = new Set();
      const studentKey = `${currentStudentName.trim().toLowerCase()}_${currentStudentMobile}`;
      
      // Check local storage first
      const localResults = JSON.parse(localStorage.getItem('quizResults') || '{}');
      Object.values(localResults).flat().forEach(result => {
        if (result.name === currentStudentName && result.mobile === currentStudentMobile) {
          // Create identifier from result data
          if (result.class && result.subject && result.quizTitle) {
            const testType = result.quizTitle.includes('Mid Term') ? 
              (result.quizTitle.includes('Mid Term 1') ? 'midterm1' : 'midterm2') : 'chapterwise';
            let identifier = '';
            if (testType === 'chapterwise') {
              identifier = `${result.class}_${result.subject}_chapterwise_${result.quizTitle}`;
            } else {
              // For midterm, try to extract sample test number from quiz title or use a generic identifier
              const sampleMatch = result.quizTitle.match(/sample\s*(\d+)/i) || result.quizTitle.match(/test\s*(\d+)/i);
              const sampleNum = sampleMatch ? `sample${sampleMatch[1]}` : 'sample1';
              identifier = `${result.class}_${result.subject}_${testType}_${sampleNum}`;
            }
            if (identifier) completed.add(identifier);
          }
        }
      });
      
      // Also check from completedQuizzes storage
      const completedQuizzes = JSON.parse(localStorage.getItem('completedQuizzes') || '{}');
      if (completedQuizzes[studentKey] && Array.isArray(completedQuizzes[studentKey])) {
        completedQuizzes[studentKey].forEach(identifier => completed.add(identifier));
      }
      
      // Try to fetch from Google Sheets (async, but we'll use cached version)
      try {
        const sheetsRankings = await fetchQuizRankingsFromSheets();
        if (sheetsRankings && Array.isArray(sheetsRankings)) {
          sheetsRankings.forEach(result => {
            if (result.name === currentStudentName && result.mobile === currentStudentMobile && result.quizTitle) {
              if (result.class && result.subject) {
                const testType = result.quizTitle.includes('Mid Term') ? 
                  (result.quizTitle.includes('Mid Term 1') ? 'midterm1' : 'midterm2') : 'chapterwise';
                let identifier = '';
                if (testType === 'chapterwise') {
                  identifier = `${result.class}_${result.subject}_chapterwise_${result.quizTitle}`;
                } else {
                  const sampleMatch = result.quizTitle.match(/sample\s*(\d+)/i) || result.quizTitle.match(/test\s*(\d+)/i);
                  const sampleNum = sampleMatch ? `sample${sampleMatch[1]}` : 'sample1';
                  identifier = `${result.class}_${result.subject}_${testType}_${sampleNum}`;
                }
                if (identifier) completed.add(identifier);
              }
            }
          });
        }
      } catch (error) {
        console.log('Could not fetch completed quizzes from Google Sheets:', error);
      }
      
      return completed;
    }

    function saveQuizResult(score, totalQuestions, timeInSeconds) {
      const quizKey = getQuizKey();
      const results = JSON.parse(localStorage.getItem('quizResults') || '{}');
      
      if (!results[quizKey]) {
        results[quizKey] = [];
      }
      
      const result = {
        name: currentStudentName,
        mobile: currentStudentMobile,
        score: score,
        total: totalQuestions,
        time: timeInSeconds,
        timestamp: Date.now()
      };
      
      results[quizKey].push(result);
      localStorage.setItem('quizResults', JSON.stringify(results));
      
      // Also save completed quiz identifier
      const completedQuizzes = JSON.parse(localStorage.getItem('completedQuizzes') || '{}');
      const studentKey = `${currentStudentName.trim().toLowerCase()}_${currentStudentMobile}`;
      if (!completedQuizzes[studentKey]) {
        completedQuizzes[studentKey] = [];
      }
      
      // Add current quiz identifier if not already present
      const classVal = classSelect.value;
      const subjectVal = subjectSelect.value;
      const testType = testTypeSelect.value;
      let quizIdentifier = '';
      
      if (testType === 'chapterwise') {
        const chapterVal = chapterSelect.value;
        const quizTitle = window.quizData[classVal][subjectVal][chapterVal]?.title || '';
        quizIdentifier = `${classVal}_${subjectVal}_chapterwise_${quizTitle}`;
      } else if (testType === 'midterm1' || testType === 'midterm2') {
        const sampleTestVal = midtermTestSelect.value;
        quizIdentifier = `${classVal}_${subjectVal}_${testType}_${sampleTestVal}`;
      }
      
      if (quizIdentifier && !completedQuizzes[studentKey].includes(quizIdentifier)) {
        completedQuizzes[studentKey].push(quizIdentifier);
        localStorage.setItem('completedQuizzes', JSON.stringify(completedQuizzes));
      }
      
      return result;
    }

    // Show congratulations modal for rank 1
    function showCongratsModal(studentName) {
      const modal = document.getElementById('congratsModal');
      const messageEl = document.getElementById('congratsMessage');
      
      const messages = [
        `Congratulations ${studentName}! üéâ<br>You've achieved <strong>Rank #1</strong>!<br>Outstanding performance! Your dedication and hard work have paid off!`,
        `Amazing work, ${studentName}! üèÜ<br>You're at the <strong>top of the leaderboard</strong>!<br>Keep up this excellent momentum and continue to shine!`,
        `Fantastic achievement, ${studentName}! ‚≠ê<br><strong>Rank #1</strong> - You're a star!<br>Your consistent efforts are truly inspiring!`
      ];
      
      const randomMessage = messages[Math.floor(Math.random() * messages.length)];
      messageEl.innerHTML = randomMessage;
      
      modal.classList.add('show');
      
      // Auto-close after 8 seconds
      setTimeout(() => {
        closeCongratsModal();
      }, 8000);
    }

    // Close congratulations modal
    function closeCongratsModal() {
      const modal = document.getElementById('congratsModal');
      modal.classList.remove('show');
    }

    // Update live ticker bar with top rankers and recent quiz takers
    function updateLiveTicker(topRankers, recentTakers = null) {
      const tickerContent = document.getElementById('tickerContent');
      const tickerContentDuplicate = document.getElementById('tickerContentDuplicate');
      const liveTickerBar = document.getElementById('liveTickerBar');
      
      if (!tickerContent || !tickerContentDuplicate) return;
      
      // Combine top rankers and recent takers
      const tickerItems = [];
      
      // Add top rankers with medals
      if (topRankers && topRankers.length > 0) {
        topRankers.slice(0, 5).forEach((ranker, index) => {
          const total = ranker.total || ranker.totalQuestions || 1;
          const percentage = Math.round((ranker.score / total) * 100);
          const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : '';
          const rankClass = index === 0 ? 'rank1' : '';
          
          tickerItems.push({
            html: `<span class="ticker-medal">${medal}</span><span><strong>${ranker.name}</strong> - Rank #${index + 1} (${percentage}%)</span>`,
            class: rankClass
          });
        });
      }
      
      // Add recent quiz takers (people who just took quizzes)
      if (recentTakers && recentTakers.length > 0) {
        recentTakers.forEach((taker) => {
          const total = taker.total || taker.totalQuestions || 1;
          const percentage = Math.round((taker.score / total) * 100);
          tickerItems.push({
            html: `<span>‚ú® <strong>${taker.name}</strong> just completed a quiz! (${percentage}%)</span>`,
            class: 'recent'
          });
        });
      }
      
      if (tickerItems.length === 0) {
        liveTickerBar.style.display = 'none';
        document.body.classList.remove('has-ticker');
        return;
      }
      
      liveTickerBar.style.display = 'block';
      document.body.classList.add('has-ticker');
      tickerContent.innerHTML = '';
      tickerContentDuplicate.innerHTML = '';
      
      // Create items
      tickerItems.forEach((itemData) => {
        const item = document.createElement('div');
        item.className = `ticker-item ${itemData.class}`;
        item.innerHTML = itemData.html;
        tickerContent.appendChild(item);
        
        // Duplicate for seamless loop
        const duplicateItem = item.cloneNode(true);
        tickerContentDuplicate.appendChild(duplicateItem);
      });
      
      // Duplicate items again for smoother scrolling if we have fewer items
      if (tickerItems.length < 8) {
        tickerItems.forEach((itemData) => {
          const item = document.createElement('div');
          item.className = `ticker-item ${itemData.class}`;
          item.innerHTML = itemData.html;
          tickerContent.appendChild(item);
          tickerContentDuplicate.appendChild(item.cloneNode(true));
        });
      }
    }

    // Load initial ticker on page load
    async function loadInitialTicker() {
      try {
        // Try to get rankings from Google Sheets first
        let allRankings = await fetchQuizRankingsFromSheets();
        
        // Fallback to local storage
        if (!allRankings || allRankings.length === 0) {
          const localResults = JSON.parse(localStorage.getItem('quizResults') || '{}');
          allRankings = Object.values(localResults).flat();
        }
        
        if (allRankings.length > 0) {
          // Get top performers (best score per student)
          const bestScores = new Map();
          for (const submission of allRankings) {
            const key = `${(submission.name || '').trim().toLowerCase()}-${submission.mobile || ''}`;
            const existing = bestScores.get(key);
            
            const total = submission.total || submission.totalQuestions || 1;
            const percent = ((submission.score || 0) / total) * 100;
            const existingPercent = existing ? ((existing.score || 0) / (existing.total || existing.totalQuestions || 1)) * 100 : 0;
            
            if (!existing || percent > existingPercent || (percent === existingPercent && (submission.time || submission.timeTaken || 9999) < (existing.time || existing.timeTaken || 9999))) {
              bestScores.set(key, submission);
            }
          }
          
          const topPerformers = Array.from(bestScores.values())
            .sort((a, b) => {
              const scoreA = a.score || 0;
              const scoreB = b.score || 0;
              const totalA = a.total || a.totalQuestions || 1;
              const totalB = b.total || b.totalQuestions || 1;
              const percentA = (scoreA / totalA) * 100;
              const percentB = (scoreB / totalB) * 100;
              return percentB - percentA;
            })
            .slice(0, 5);
          
          // Get recent quiz takers (last 5 submissions within last hour)
          const oneHourAgo = Date.now() - (60 * 60 * 1000);
          const recentTakers = allRankings
            .filter(r => (r.timestamp || 0) > oneHourAgo)
            .sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0))
            .slice(0, 5);
          
          updateLiveTicker(topPerformers, recentTakers);
        } else {
          document.getElementById('liveTickerBar').style.display = 'none';
          document.body.classList.remove('has-ticker');
        }
      } catch (error) {
        console.error('Error loading initial ticker:', error);
        document.getElementById('liveTickerBar').style.display = 'none';
        document.body.classList.remove('has-ticker');
      }
    }

    async function displayRankingsFromSheets(currentResult) {
      console.log('--- Starting Leaderboard Generation ---');
      console.log('Current user result:', currentResult);

      // Show loading state
      userRank.innerHTML = '<div style="text-align: center; padding: 1rem;"><div class="loading"></div><p style="margin-top: 0.5rem; color: #64748b;">Loading rankings...</p></div>';
      topRankers.innerHTML = '<div style="text-align: center; padding: 1rem;"><div class="loading"></div><p style="margin-top: 0.5rem; color: #64748b;">Loading leaderboard...</p></div>';
      rankingSection.style.display = 'block';

      try {
        // Fetch rankings for this specific quiz from Google Sheets (optimized)
        const currentTitle = currentResult.quizTitle.trim();
        let allRankings = await fetchQuizRankingsFromSheets(currentTitle);
        console.log(`Fetched ${allRankings ? allRankings.length : 0} rankings for quiz: ${currentTitle}`);

        // Fallback to local storage if API fails
        if (!allRankings || !Array.isArray(allRankings) || allRankings.length === 0) {
          console.warn('Could not fetch from Google Sheets or data is invalid, falling back to local data.');
          const localResults = JSON.parse(localStorage.getItem('quizResults') || '{}');
          allRankings = Object.values(localResults).flat();
          
          // Filter local results by quiz title
          allRankings = allRankings.filter(r => 
            r.quizTitle && r.quizTitle.trim().includes(currentTitle)
          );
        }

        // Add the current user's result to the list for ranking
        const currentUserData = {
            name: currentResult.name,
            mobile: currentResult.mobile,
            score: currentResult.score,
            total: currentResult.total,
            time: currentResult.time,
            timestamp: currentResult.timestamp,
            quizTitle: currentResult.quizTitle
        };
        
        // Check if current user already exists in rankings
        const existingUserIndex = allRankings.findIndex(r => 
          r.timestamp === currentResult.timestamp || 
          (r.name === currentResult.name && r.mobile === currentResult.mobile)
        );
        
        if (existingUserIndex === -1) {
          allRankings.push(currentUserData);
        } else {
          // Update existing entry if current score is better
          const existing = allRankings[existingUserIndex];
          if (currentResult.score > existing.score || 
              (currentResult.score === existing.score && currentResult.time < existing.time)) {
            allRankings[existingUserIndex] = currentUserData;
          }
        }

        // De-duplicate results, keeping the best score for each student
        const bestScores = new Map();
        for (const submission of allRankings) {
          // Normalize the key to be case-insensitive and handle missing mobile numbers
          const key = `${(submission.name || '').trim().toLowerCase()}-${submission.mobile || ''}`;
          const existing = bestScores.get(key);

          if (!existing || submission.score > existing.score || 
              (submission.score === existing.score && (submission.time || submission.timeTaken || 9999) < (existing.time || existing.timeTaken || 9999))) {
            bestScores.set(key, submission);
          }
        }
        
        let quizSubmissions = Array.from(bestScores.values());

        // Sort by score (desc) and then time (asc)
        quizSubmissions.sort((a, b) => {
          const scoreA = a.score || 0;
          const scoreB = b.score || 0;
          const totalA = a.total || a.totalQuestions || 1;
          const totalB = b.total || b.totalQuestions || 1;
          const percentA = (scoreA / totalA) * 100;
          const percentB = (scoreB / totalB) * 100;
          
          if (Math.abs(percentB - percentA) > 0.01) {
            return percentB - percentA;
          }
          return (a.time || a.timeTaken || 9999) - (b.time || b.timeTaken || 9999);
        });

        // Find the current user's rank
        const userRankNum = quizSubmissions.findIndex(r => 
          r.timestamp === currentResult.timestamp || 
          (r.name === currentResult.name && r.mobile === currentResult.mobile)
        ) + 1;

        // Show congratulations modal if rank 1 (even if only one person has taken the quiz)
        if (userRankNum === 1) {
          setTimeout(() => {
            showCongratsModal(currentResult.name);
          }, 500); // Small delay to ensure rankings are displayed first
        }

        // Display user's rank
        const percentage = Math.round((currentResult.score / currentResult.total) * 100);
        userRank.innerHTML = `
          <div class="rank-number">#${userRankNum > 0 ? userRankNum : quizSubmissions.length}</div>
          <div style="color: #92400e; font-weight: 600; font-size: 1.1rem;">Your Rank</div>
          <div style="color: #78716c; margin-top: 0.5rem;">
            Score: ${currentResult.score}/${currentResult.total} (${percentage}%) | 
            Time: ${Math.floor(currentResult.time/60)}:${(currentResult.time%60).toString().padStart(2,'0')}
          </div>
          <div style="color: #64748b; font-size: 0.9rem; margin-top: 0.5rem;">
            Out of ${quizSubmissions.length} student${quizSubmissions.length !== 1 ? 's' : ''}
          </div>
        `;

        // Update live ticker with top rankers (and include current user as recent taker if not in top 5)
        const topRankersForTicker = quizSubmissions.slice(0, 5);
        const recentTakers = quizSubmissions.length > 5 && 
          !topRankersForTicker.find(r => r.timestamp === currentResult.timestamp) 
          ? [currentUserData] : [];
        updateLiveTicker(topRankersForTicker, recentTakers);

        // Display the leaderboard - show only top 3 by default
        topRankers.innerHTML = '';
        if (quizSubmissions.length <= 1) {
          topRankers.innerHTML = '<div style="text-align: center; color: #92400e; padding: 1rem;">You are the first to take this quiz!</div>';
        } else {
          // Store all rankers globally for "Show All" functionality
          window.allQuizRankers = quizSubmissions;
          
          quizSubmissions.forEach((result, index) => {
            const isCurrentUser = result.timestamp === currentResult.timestamp || 
                                  (result.name === currentResult.name && result.mobile === currentResult.mobile);
            const rankClass = index === 0 ? 'gold' : index === 1 ? 'silver' : index === 2 ? 'bronze' : '';
            const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : '';
            
            // Gracefully handle missing 'total' property
            const total = result.total || result.totalQuestions || currentResult.total;
            const percentageText = `(${Math.round((result.score / total) * 100)}%)`;
            const time = result.time || result.timeTaken || 0;

            const rankItem = document.createElement('div');
            rankItem.className = `rank-item ${rankClass}`;
            if (isCurrentUser) {
              rankItem.style.border = '2px solid #3b82f6';
              rankItem.style.boxShadow = '0 4px 15px rgba(59, 130, 246, 0.3)';
            }
            
            // Hide ranks beyond the top 3 initially
            if (index >= 3) {
              rankItem.style.display = 'none';
              rankItem.classList.add('extra-ranker');
              rankItem.setAttribute('data-rank-index', index);
            } else {
              rankItem.style.display = 'flex';
            }

            rankItem.innerHTML = `
              <div>
                <strong>${medal} ${result.name}</strong><br>
                <small style="color: #6b7280;">${result.score}/${total} ${percentageText} | ${Math.floor(time/60)}:${(time%60).toString().padStart(2,'0')}</small>
              </div>
              <div style="font-weight: bold; color: #92400e;">#${index + 1}</div>
            `;
            topRankers.appendChild(rankItem);
          });

          // Add a 'Show All Rankers' button if there are more than 3 rankers
          if (quizSubmissions.length > 3) {
            const showAllBtn = document.createElement('button');
            showAllBtn.textContent = `Show All Rankers (${quizSubmissions.length - 3} more)`;
            showAllBtn.className = 'btn-primary';
            showAllBtn.style.marginTop = '1rem';
            showAllBtn.style.width = '100%';
            showAllBtn.id = 'showAllRankersBtn';
            showAllBtn.onclick = function() {
              // Find all rank items with the extra-ranker class
              const extraRankers = topRankers.querySelectorAll('.extra-ranker');
              console.log(`Found ${extraRankers.length} extra rankers to show out of ${quizSubmissions.length} total`);
              
              if (extraRankers.length === 0) {
                console.warn('No extra rankers found!');
                return;
              }
              
              // Show all extra rankers
              extraRankers.forEach((el, idx) => {
                // Remove any inline display style and set to flex
                el.style.removeProperty('display');
                el.style.display = 'flex';
                el.style.animation = `fadeInUp 0.3s ease-out ${idx * 0.05}s both`;
                console.log(`Showing ranker ${idx + 4} (index ${idx}):`, el.textContent);
              });
              
              showAllBtn.style.display = 'none';
              
              // Add a "Show Less" button
              const showLessBtn = document.createElement('button');
              showLessBtn.textContent = 'Show Less';
              showLessBtn.className = 'btn-primary';
              showLessBtn.style.marginTop = '1rem';
              showLessBtn.style.width = '100%';
              showLessBtn.style.background = 'linear-gradient(135deg, #64748b, #475569)';
              showLessBtn.id = 'showLessRankersBtn';
              showLessBtn.onclick = function() {
                extraRankers.forEach(el => {
                  el.style.display = 'none';
                  el.style.animation = '';
                });
                showLessBtn.remove();
                showAllBtn.style.display = 'block';
              };
              topRankers.appendChild(showLessBtn);
            };
            topRankers.appendChild(showAllBtn);
          }
        }

        rankingSection.classList.add('fade-in');
      } catch (error) {
        console.error('Error displaying rankings:', error);
        userRank.innerHTML = '<div style="text-align: center; color: #ef4444; padding: 1rem;">Error loading your rank. Please try again.</div>';
        topRankers.innerHTML = '<div style="text-align: center; color: #ef4444; padding: 1rem;">Error loading leaderboard. Please try again.</div>';
      }
    }

    // Quiz functions
    function shuffleArray(array) {
      const newArray = [...array];
      for (let i = newArray.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
      }
      return newArray;
    }

    function randomizeQuizOptions(quiz) {
      if (!quiz || !quiz.questions) return quiz;
      quiz.questions.forEach((question, index) => {
        if (!question.options || !Array.isArray(question.options)) return;
        const correctAnswer = question.answer;
        question.options = shuffleArray(question.options);
        if (!question.options.includes(correctAnswer)) {
          question.options[0] = correctAnswer;
        }
        question.answer = correctAnswer;
      });
      return quiz;
    }

    function resetDropdown(sel, msg) {
      sel.innerHTML = `<option value="">${msg}</option>`;
    }

    function populateClassDropdown() {
      resetDropdown(classSelect, "Choose your class...");
      
      if (typeof window.quizData === 'undefined') {
        classSelect.innerHTML = '<option value="">Loading quiz data...</option>';
        setTimeout(() => {
          if (typeof window.quizData === 'undefined') {
            classSelect.innerHTML = '<option value="">Error: Please refresh the page</option>';
          } else {
            populateClassDropdown();
          }
        }, 2000);
        return;
      }
      
      if (!window.quizData || Object.keys(window.quizData).length === 0) {
        classSelect.innerHTML = '<option value="">No quiz data available</option>';
        return;
      }
      
      Object.keys(window.quizData).forEach(c => {
        classSelect.innerHTML += `<option value="${c}">Class ${c}</option>`;
      });
      resetDropdown(subjectSelect, "Choose subject...");
      resetDropdown(chapterSelect, "Choose quiz topic...");
    }

    function populateSubjectDropdown() {
      resetDropdown(subjectSelect, "Choose subject...");
      resetDropdown(chapterSelect, "Choose quiz topic...");
      quizArea.style.display = "none";
      testTypeDropdownGroup.style.display = 'none';
      chapterDropdownContainer.style.display = 'none';
      midtermDropdownContainer.style.display = 'none';
      startQuizButtonContainer.style.display = 'none';
      
      const classVal = classSelect.value;
      if (!classVal) {
        subjectDropdownGroup.style.display = 'none';
        updateQuizStatsBanner();
        return;
      }
      
      // Show subject dropdown
      subjectDropdownGroup.style.display = 'block';
      
      const subjects = Object.keys(window.quizData[classVal]);
      subjects.forEach(subject => {
        subjectSelect.innerHTML += `<option value="${subject}">${subject.charAt(0).toUpperCase() + subject.slice(1)}</option>`;
      });
      
      updateQuizStatsBanner();
    }
    
    // Update quiz statistics banner
    async function updateQuizStatsBanner() {
      if (!currentStudentName || !currentStudentMobile) {
        document.getElementById('quizStatsBanner').style.display = 'none';
        return;
      }
      
      const classVal = classSelect.value;
      if (!classVal) {
        document.getElementById('quizStatsBanner').style.display = 'none';
        return;
      }
      
      const completedQuizzes = await getCompletedQuizIdentifiers();
      let totalAvailable = 0;
      let totalCompleted = 0;
      
      // Count all quizzes across all subjects for this class
      if (window.quizData && window.quizData[classVal]) {
        Object.keys(window.quizData[classVal]).forEach(subjectVal => {
          // Count chapterwise quizzes
          if (window.quizData[classVal][subjectVal]) {
            window.quizData[classVal][subjectVal].forEach((quiz, i) => {
              const quizIdentifier = `${classVal}_${subjectVal}_chapterwise_${quiz.title}`;
              if (completedQuizzes.has(quizIdentifier)) {
                totalCompleted++;
              } else {
                totalAvailable++;
              }
            });
          }
          
          // Count midterm tests (3 each for midterm1 and midterm2)
          ['midterm1', 'midterm2'].forEach(testType => {
            for (let i = 1; i <= 3; i++) {
              const quizIdentifier = `${classVal}_${subjectVal}_${testType}_sample${i}`;
              if (completedQuizzes.has(quizIdentifier)) {
                totalCompleted++;
              } else {
                totalAvailable++;
              }
            }
          });
        });
      }
      
      if (totalAvailable > 0 || totalCompleted > 0) {
        document.getElementById('quizStatsBanner').style.display = 'block';
        document.getElementById('availableQuizzesCount').textContent = totalAvailable;
        document.getElementById('completedQuizzesCount').textContent = totalCompleted;
      } else {
        document.getElementById('quizStatsBanner').style.display = 'none';
      }
    }

    async function populateChapterDropdown() {
      resetDropdown(chapterSelect, "Choose quiz topic...");
      const classVal = classSelect.value;
      const subjectVal = subjectSelect.value;
      if (!classVal || !subjectVal) return;
      
      // Get completed quizzes for current student
      const completedQuizzes = await getCompletedQuizIdentifiers();
      
      // This part remains for chapterwise tests
      if (window.quizData && window.quizData[classVal] && window.quizData[classVal][subjectVal]) {
        let availableCount = 0;
        let completedCount = 0;
        
        window.quizData[classVal][subjectVal].forEach((quiz, i) => {
          const quizIdentifier = `${classVal}_${subjectVal}_chapterwise_${quiz.title}`;
          const isCompleted = completedQuizzes.has(quizIdentifier);
          
          if (isCompleted) {
            completedCount++;
            // Show completed quizzes but still allow selection (not disabled)
            chapterSelect.innerHTML += `<option value="${i}" style="color: #6b7280;">${quiz.title} ‚úì Completed</option>`;
          } else {
            availableCount++;
            // Show available quizzes with NEW badge
            chapterSelect.innerHTML += `<option value="${i}" style="font-weight: 600; color: #059669;">‚ú® ${quiz.title} (NEW)</option>`;
          }
        });
        
        // Show statistics
        if (availableCount === 0 && completedCount > 0) {
          const firstOption = chapterSelect.querySelector('option[value=""]');
          if (firstOption) {
            firstOption.textContent = `Choose quiz topic... (All ${completedCount} completed - You can retake any!)`;
          }
        } else if (availableCount > 0) {
          // Add a separator option showing count
          const firstOption = chapterSelect.querySelector('option[value=""]');
          if (firstOption) {
            firstOption.textContent = `Choose quiz topic... (${availableCount} new available)`;
          }
        }
      }
      
      // Check if selections are complete
      checkSelectionsComplete();
      updateQuizStatsBanner();
    }

    function handleTestTypeChange() {
      const testType = testTypeSelect.value;
      console.log('Test type changed to:', testType);
      
      // Hide all containers first
      chapterDropdownContainer.style.display = 'none';
      midtermDropdownContainer.style.display = 'none';
      quizArea.style.display = 'none';
      startQuizButtonContainer.style.display = 'none';

      if (!testType) {
        return;
      }

      if (testType === 'chapterwise') {
        console.log('Showing chapterwise test options');
        chapterDropdownContainer.style.display = 'block';
        populateChapterDropdown();
      } else if (testType === 'midterm1' || testType === 'midterm2') {
        console.log('Showing midterm test options for:', testType);
        midtermDropdownContainer.style.display = 'block';
        populateMidtermTestDropdown();
      } else {
        console.log('No valid test type selected');
      }
      
      updateQuizStatsBanner();
    }
    
    // Function to check if all selections are made and show Start Quiz button
    function checkSelectionsComplete() {
      const classVal = classSelect.value;
      const subjectVal = subjectSelect.value;
      const testType = testTypeSelect.value;
      
      if (!classVal || !subjectVal || !testType) {
        startQuizButtonContainer.style.display = 'none';
        return;
      }
      
      let isComplete = false;
      
      if (testType === 'chapterwise') {
        const chapterVal = chapterSelect.value;
        isComplete = chapterVal !== '';
      } else if (testType === 'midterm1' || testType === 'midterm2') {
        const sampleTestVal = midtermTestSelect.value;
        isComplete = sampleTestVal !== '';
      }
      
      if (isComplete) {
        startQuizButtonContainer.style.display = 'block';
      } else {
        startQuizButtonContainer.style.display = 'none';
      }
    }

    async function populateMidtermTestDropdown() {
      resetDropdown(midtermTestSelect, "Choose sample test...");
      const classVal = classSelect.value;
      const subjectVal = subjectSelect.value;
      const testType = testTypeSelect.value;
      
      if (!classVal || !subjectVal || !testType) return;
      
      // Get completed quizzes for current student
      const completedQuizzes = await getCompletedQuizIdentifiers();
      
      const testOptions = [
        { value: 'sample1', label: 'Sample Test 1' },
        { value: 'sample2', label: 'Sample Test 2' },
        { value: 'sample3', label: 'Sample Test 3' }
      ];
      
      let availableCount = 0;
      let completedCount = 0;
      
      testOptions.forEach(test => {
        const quizIdentifier = `${classVal}_${subjectVal}_${testType}_${test.value}`;
        const isCompleted = completedQuizzes.has(quizIdentifier);
        
        if (isCompleted) {
          completedCount++;
          midtermTestSelect.innerHTML += `<option value="${test.value}" style="color: #6b7280;">${test.label} ‚úì Completed</option>`;
        } else {
          availableCount++;
          midtermTestSelect.innerHTML += `<option value="${test.value}" style="font-weight: 600; color: #059669;">‚ú® ${test.label} (NEW)</option>`;
        }
      });
      
      // Update placeholder
      if (availableCount === 0 && completedCount > 0) {
        const firstOption = midtermTestSelect.querySelector('option[value=""]');
        if (firstOption) {
          firstOption.textContent = `Choose sample test... (All ${completedCount} completed - You can retake any!)`;
        }
      } else if (availableCount > 0) {
        const firstOption = midtermTestSelect.querySelector('option[value=""]');
        if (firstOption) {
          firstOption.textContent = `Choose sample test... (${availableCount} new available)`;
        }
      }
      
      // Check if selections are complete
      checkSelectionsComplete();
    }

    function assembleMidtermTest(allQuestions) {
      console.log('Assembling midterm test with questions:', allQuestions);
      
      const questionCounts = {
        mcq: 25,
        fill_in_blank: 10,
        true_false: 10,
        assertion_reasoning: 5
      };

      let assembledQuestions = [];
      
      // First, verify we have enough questions of each type
      for (const type in questionCounts) {
        const count = allQuestions.filter(q => q.type === type).length;
        console.log(`Found ${count} questions of type ${type}`);
        if (count < questionCounts[type]) {
          console.warn(`Warning: Only found ${count} questions of type ${type}, but need ${questionCounts[type]}`);
        }
      }

      // Shuffle the questions
      const shuffledQuestions = shuffleArray([...allQuestions]);
      
      // Select questions by type
      for (const type in questionCounts) {
        const needed = questionCounts[type];
        const filtered = shuffledQuestions.filter(q => q.type === type);
        const selected = filtered.slice(0, needed);
        
        console.log(`Selected ${selected.length} of ${filtered.length} available ${type} questions`);
        
        // If we don't have enough questions, take what we have
        if (selected.length < needed) {
          console.warn(`Warning: Only found ${selected.length} questions of type ${type}, but needed ${needed}`);
        }
        
        assembledQuestions = [...assembledQuestions, ...selected];
      }

      // Shuffle the final list of questions
      const finalQuestions = shuffleArray(assembledQuestions);
      console.log(`Assembled ${finalQuestions.length} questions total`);

      return {
        title: "Mid Term Sample Test",
        questions: finalQuestions
      };
    }

    function showQuiz() {
      // Hide error message if any
      hideError();
      
      // Validate all selections are made
      if (!classSelect || !subjectSelect || !testTypeSelect) {
        console.error('Required dropdowns not found');
        return;
      }
      
      const selectedClass = classSelect.value;
      const selectedSubject = subjectSelect.value;
      const selectedTestType = testTypeSelect.value;
      
      if (!selectedClass || !selectedSubject || !selectedTestType) {
        alert('Please complete all selections before starting the quiz.');
        return;
      }
      
      if (selectedTestType === 'chapterwise') {
        if (!chapterSelect || !chapterSelect.value) {
          alert('Please select a chapter before starting the quiz.');
          return;
        }
      } else if (selectedTestType === 'midterm1' || selectedTestType === 'midterm2') {
        if (!midtermTestSelect || !midtermTestSelect.value) {
          alert('Please select a sample test before starting the quiz.');
          return;
        }
      }
      
      // Don't enable anti-cheating yet - wait until quiz is successfully loaded
      // Show quiz area and hide student form and dropdowns (will revert if loading fails)
      document.querySelector('.quiz-area').style.display = 'block';
      document.querySelector('.student-form').style.display = 'none';
      document.querySelector('.dropdowns').style.display = 'none';

      quizForm.innerHTML = "";
      resultDiv.style.display = "none";
      rankingSection.style.display = "none";
      stopTimer();
      answeredQuestions = 0;

      if (!selectedClass || !selectedSubject || !selectedTestType) {
        // Revert UI changes
        document.querySelector('.quiz-area').style.display = 'none';
        document.querySelector('.dropdowns').style.display = 'block';
        return;
      }

      try {
        if (selectedTestType === 'chapterwise') {
          const chapterVal = chapterSelect.value;
          if (chapterVal === "") return;
          currentQuiz = JSON.parse(JSON.stringify(window.quizData[selectedClass][selectedSubject][chapterVal]));
          randomizeQuizOptions(currentQuiz);
        } else if (selectedTestType === 'midterm1' || selectedTestType === 'midterm2') {
          const sampleTestVal = midtermTestSelect.value;
          if (sampleTestVal === "") return;
          try {
            console.log('Midterm data structure:', window.midtermQuizData);
            
            // Convert selectedClass to string to match the data structure
            const classKey = String(selectedClass);
            
            // Get the class data
            const classData = window.midtermQuizData[classKey];
            if (!classData) throw new Error(`Class ${selectedClass} not found in midterm data`);
            
            // Get the subject data (handle both spaces and underscores in subject names)
            const subjectKeys = Object.keys(classData);
            // Normalize both the selected subject and available subjects by replacing underscores with spaces
            const normalizedSubjectVal = selectedSubject.toLowerCase().replace(/_/g, ' ');
            const subjectKey = subjectKeys.find(key => 
              key.toLowerCase().replace(/_/g, ' ') === normalizedSubjectVal
            );
            if (!subjectKey) throw new Error(`Subject '${selectedSubject}' not found in class data. Available subjects: ${subjectKeys.join(', ')}`);
            
            // Use the original key from the data to access the subject
            const subjectData = classData[subjectKey];
            
            // Get the midterm data
            const midtermKey = selectedTestType; // Use the selected test type (midterm1 or midterm2)
            const midtermData = subjectData[midtermKey];
            if (!midtermData) throw new Error(`${selectedTestType} not found in subject data`);
            
            // Get the sample test data
            const allMidtermQuestions = midtermData[sampleTestVal];
            if (!allMidtermQuestions) throw new Error(`Sample test ${sampleTestVal} not found`);
            
            console.log('Found questions:', allMidtermQuestions);
            currentQuiz = assembleMidtermTest(allMidtermQuestions);
          } catch (error) {
            console.error('Error loading midterm test:', error);
            // Revert UI changes before showing alert
            document.querySelector('.quiz-area').style.display = 'none';
            document.querySelector('.dropdowns').style.display = 'block';
            isShowingAlert = true;
            alert(`Error loading midterm test: ${error.message}`);
            isShowingAlert = false;
            return;
          }
        }

        if (!currentQuiz || !currentQuiz.questions || currentQuiz.questions.length === 0) {
          // Revert UI changes before showing alert
          document.querySelector('.quiz-area').style.display = 'none';
          document.querySelector('.dropdowns').style.display = 'block';
          isShowingAlert = true;
          alert('No questions found for this selection. Please add questions to the data file.');
          isShowingAlert = false;
          return;
        }

      } catch (e) {
        console.error("Error loading quiz:", e);
        // Revert UI changes before showing alert
        document.querySelector('.quiz-area').style.display = 'none';
        document.querySelector('.dropdowns').style.display = 'block';
        isShowingAlert = true;
        alert('Could not load the quiz. Please check the data source and your selections.');
        isShowingAlert = false;
        return;
      }
      
      // Only enable anti-cheating AFTER successfully loading the quiz
      enableAntiCheating();

      quizTitle.textContent = currentQuiz.title;
      document.getElementById('statQuestions').textContent = currentQuiz.questions.length;
      
      currentQuiz.questions.forEach((q, idx) => {
        const questionDiv = document.createElement('div');
        questionDiv.className = 'question fade-in';
        questionDiv.setAttribute('data-question-idx', idx);
        questionDiv.style.animationDelay = `${idx * 0.1}s`;
        let optionsHtml = '';

        if (!q.type) {
          optionsHtml = q.options.map(opt => `
            <label class="option-item" onclick="this.querySelector('input').click()">
              <input type="radio" name="q${idx}" value="${opt}" class="option-radio" onchange="this.closest('.option-item').classList.toggle('selected', this.checked)">
              <span class="option-text">${opt}</span>
            </label>
          `).join('');
        } else {
          switch (q.type) {
            case 'mcq':
            case 'assertion_reasoning':
              optionsHtml = q.options.map(opt => `
                <label class="option-item" onclick="this.querySelector('input').click()">
                  <input type="radio" name="q${idx}" value="${opt}" class="option-radio" onchange="this.closest('.option-item').classList.toggle('selected', this.checked)">
                  <span class="option-text">${opt}</span>
                </label>
              `).join('');
              break;
            case 'fill_in_blank':
              optionsHtml = `
                <div class="fill-blank-container">
                  <input type="text" name="q${idx}" class="form-input fill-blank-input" placeholder="Type your answer here">
                </div>
              `;
              break;
            case 'true_false':
              optionsHtml = `
                <label class="option-item" onclick="this.querySelector('input').click()">
                  <input type="radio" name="q${idx}" value="True" class="option-radio" onchange="this.closest('.option-item').classList.toggle('selected', this.checked)">
                  <span class="option-text">True</span>
                </label>
                <label class="option-item" onclick="this.querySelector('input').click()">
                  <input type="radio" name="q${idx}" value="False" class="option-radio" onchange="this.closest('.option-item').classList.toggle('selected', this.checked)">
                  <span class="option-text">False</span>
                </label>
              `;
              break;
          }
        }

        questionDiv.innerHTML = `
          <div class="question-text">${idx + 1}. ${q.q}</div>
          <div class="options">${optionsHtml}</div>
        `;
        quizForm.appendChild(questionDiv);
      });
      
      // Add submit button with confirmation
      const submitBtn = document.createElement('button');
      submitBtn.type = 'button';
      submitBtn.className = 'btn-primary pulse';
      submitBtn.id = 'submitBtn';
      submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Submit Quiz';
      submitBtn.onclick = () => {
        // Count answered questions
        const totalQuestions = currentQuiz.questions.length;
        const answeredQuestions = Array.from(document.querySelectorAll('input[type="radio"]:checked, input[type="text"][name^="q"]')).filter(
          input => input.type === 'radio' || input.value.trim() !== ''
        ).length;
        
        // Show confirmation dialog
        if (confirm(`You have answered ${answeredQuestions} out of ${totalQuestions} questions. Are you sure you want to submit?`)) {
          checkAnswers();
        }
      };
      quizForm.appendChild(submitBtn);
      
      // Add option selection handlers
      document.querySelectorAll('input[type="radio"]').forEach(radio => {
        radio.addEventListener('change', function() {
          // Update progress
          answeredQuestions = document.querySelectorAll('input[type="radio"]:checked').length;
          updateProgress();
          
          // Visual feedback
          this.closest('.option-item').classList.add('selected');
          const questionOptions = this.closest('.options').querySelectorAll('.option-item');
          questionOptions.forEach(opt => {
            if (opt !== this.closest('.option-item')) {
              opt.classList.remove('selected');
            }
          });
        });
      });
      
      quizArea.style.display = "block";
      quizArea.classList.add('fade-in');
      updateProgress();
      startTimer();
    }

    function tryAnotherQuiz() {
      // Disable anti-cheating measures
      disableAntiCheating();
      
      // Reset the form and show the dropdowns again
      document.getElementById('quizForm').reset();
      document.getElementById('result').style.display = 'none';
      document.querySelector('.ranking-section').style.display = 'none';
      document.getElementById('floatingStats').style.display = 'none';
      
      // Reset the timer and progress
      stopTimer();
      document.getElementById('timeDisplay').textContent = '00:00';
      document.getElementById('progressBar').style.width = '0%';
      
      // Hide quiz area
      document.querySelector('.quiz-area').style.display = 'none';
      
      // Show the dropdowns again
      const dropdowns = document.querySelector('.dropdowns');
      dropdowns.style.display = 'block';
      
      // Reset dropdown values but keep selections
      // Don't reset class, subject, test type - just reset the final selection
      document.getElementById('chapterSelect').value = '';
      document.getElementById('midtermTestSelect').value = '';
      
      // Hide final dropdown containers
      document.getElementById('chapterDropdownContainer').style.display = 'none';
      document.getElementById('midtermDropdownContainer').style.display = 'none';
      
      // Hide start button
      startQuizButtonContainer.style.display = 'none';
      
      // Re-populate based on current selections
      if (classSelect.value) {
        populateSubjectDropdown();
        if (subjectSelect.value) {
          subjectDropdownGroup.style.display = 'block';
          testTypeDropdownGroup.style.display = 'block';
          if (testTypeSelect.value) {
            handleTestTypeChange();
          }
        }
      }
      
      // Clear the quiz title
      document.getElementById('quizTitle').textContent = '';
      
      // Clear the quiz form
      const quizForm = document.getElementById('quizForm');
      while (quizForm.firstChild) {
        quizForm.removeChild(quizForm.firstChild);
      }
      
      // Remove submit button if it exists
      const submitBtn = document.getElementById('submitBtn');
      if (submitBtn) {
        submitBtn.remove();
      }
      
      // Scroll to top
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    
    // Anti-cheating functions
    function enableAntiCheating() {
      // Disable right-click
      document.addEventListener('contextmenu', preventRightClick);
      
      // Disable text selection
      document.addEventListener('selectstart', preventSelection);
      
      // Disable copy, cut, paste
      document.addEventListener('copy', preventCopy);
      document.addEventListener('cut', preventCopy);
      document.addEventListener('paste', preventPaste);
      
      // Disable F12, Ctrl+Shift+I, Ctrl+Shift+J, Ctrl+U
      document.addEventListener('keydown', preventDevTools);
      
      // Prevent tab switching
      document.addEventListener('visibilitychange', handleVisibilityChange);
      
      // Disable print screen (partial - can't fully prevent)
      document.addEventListener('keydown', preventPrintScreen);
      
      // Warn on tab switch attempt
      window.addEventListener('blur', handleWindowBlur);
      
      // Disable drag and drop
      document.addEventListener('dragstart', preventDrag);
      document.addEventListener('drop', preventDrop);
    }
    
    function disableAntiCheating() {
      document.removeEventListener('contextmenu', preventRightClick);
      document.removeEventListener('selectstart', preventSelection);
      document.removeEventListener('copy', preventCopy);
      document.removeEventListener('cut', preventCopy);
      document.removeEventListener('paste', preventPaste);
      document.removeEventListener('keydown', preventDevTools);
      document.removeEventListener('visibilitychange', handleVisibilityChange);
      document.removeEventListener('keydown', preventPrintScreen);
      window.removeEventListener('blur', handleWindowBlur);
      document.removeEventListener('dragstart', preventDrag);
      document.removeEventListener('drop', preventDrop);
    }
    
    function preventRightClick(e) {
      e.preventDefault();
      return false;
    }
    
    function preventSelection(e) {
      e.preventDefault();
      return false;
    }
    
    function preventCopy(e) {
      e.preventDefault();
      alert('Copying is not allowed during the quiz!');
      return false;
    }
    
    function preventPaste(e) {
      e.preventDefault();
      alert('Pasting is not allowed during the quiz!');
      return false;
    }
    
    function preventDevTools(e) {
      // F12
      if (e.keyCode === 123) {
        e.preventDefault();
        alert('Developer tools are disabled during the quiz!');
        return false;
      }
      // Ctrl+Shift+I
      if (e.ctrlKey && e.shiftKey && e.keyCode === 73) {
        e.preventDefault();
        alert('Developer tools are disabled during the quiz!');
        return false;
      }
      // Ctrl+Shift+J
      if (e.ctrlKey && e.shiftKey && e.keyCode === 74) {
        e.preventDefault();
        alert('Developer tools are disabled during the quiz!');
        return false;
      }
      // Ctrl+U (View Source)
      if (e.ctrlKey && e.keyCode === 85) {
        e.preventDefault();
        alert('View source is disabled during the quiz!');
        return false;
      }
    }
    
    function handleVisibilityChange() {
      if (document.hidden && !isShowingAlert) {
        alert('‚ö†Ô∏è Warning: You switched tabs/windows. This may be considered cheating. Please stay on the quiz page.');
      }
    }
    
    function preventPrintScreen(e) {
      // Print Screen key
      if (e.keyCode === 44) {
        e.preventDefault();
        alert('Screenshots are not allowed during the quiz!');
        return false;
      }
    }
    
    function handleWindowBlur() {
      // Don't show warning if we're currently showing an alert
      if (isShowingAlert) return;
      alert('‚ö†Ô∏è Warning: You switched away from the quiz. Please stay on the quiz page.');
    }
    
    function preventDrag(e) {
      e.preventDefault();
      return false;
    }
    
    function preventDrop(e) {
      e.preventDefault();
      return false;
    }

    function checkAnswers() {
      stopTimer();
      
      // Disable anti-cheating measures after submission
      disableAntiCheating();
      
      let score = 0;
      const totalQuestions = currentQuiz.questions.length;
      const quizFormInputs = quizForm.elements;

      // Disable all inputs after submission
      for (let item of quizFormInputs) {
        item.disabled = true;
      }

      currentQuiz.questions.forEach((q, idx) => {
        const questionElement = document.querySelector(`.question[data-question-idx="${idx}"]`);
        const questionOptions = document.querySelectorAll(`input[name="q${idx}"]`);
        let userAnswer = null;
        let isCorrect = false;

        if (q.type === 'fill_in_blank') {
          const input = questionOptions[0];
          userAnswer = input ? input.value.trim().toLowerCase() : '';
          isCorrect = userAnswer === q.answer.toLowerCase();
          
          // Add appropriate class to input
          input.classList.add(isCorrect ? 'correct' : 'incorrect');
          
          // Add correct answer text if wrong
          if (!isCorrect) {
            const correctAnswerEl = document.createElement('div');
            correctAnswerEl.className = 'correct-answer-text';
            correctAnswerEl.textContent = `Correct answer: ${q.answer}`;
            input.parentNode.insertBefore(correctAnswerEl, input.nextSibling);
          } else {
            score++;
          }
        } else { // MCQ, True/False, Assertion/Reasoning
          // First, mark all correct answers
          questionOptions.forEach(opt => {
            const optionItem = opt.closest('.option-item');
            if (opt.value === q.answer) {
              optionItem.classList.add('correct-answer');
            }
          });
          
          // Then check user's selection
          let hasSelected = false;
          questionOptions.forEach(opt => {
            if (opt.checked) {
              hasSelected = true;
              userAnswer = opt.value;
              const optionItem = opt.closest('.option-item');
              
              if (userAnswer === q.answer) {
                optionItem.classList.add('selected', 'correct-answer');
                isCorrect = true;
                score++;
              } else {
                optionItem.classList.add('incorrect-answer');
              }
            }
          });
          
          // If no option was selected but there is a correct answer
          if (!hasSelected && q.answer) {
            questionOptions.forEach(opt => {
              if (opt.value === q.answer) {
                opt.closest('.option-item').classList.add('correct-answer', 'not-selected');
              }
            });
          }
        }
      });
      
      const currentResult = saveQuizResult(score, currentQuiz.questions.length, secondsElapsed);
      const percentage = Math.round((score / currentQuiz.questions.length) * 100);
      
      // Add extra info to currentResult for filtering
      currentResult.class = classSelect.value;
      currentResult.subject = subjectSelect.value;
      currentResult.quizTitle = currentQuiz.title;

      // Save to Google Sheets
      saveQuizResultToSheets({
        name: currentStudentName,
        mobile: currentStudentMobile,
        class: classSelect.value,
        subject: subjectSelect.value,
        quizTitle: currentQuiz.title,
        score: score,
        totalQuestions: currentQuiz.questions.length,
        timeTaken: secondsElapsed
      });
      
      resultDiv.innerHTML = `
        <div class="result-score">${score}/${currentQuiz.questions.length}</div>
        <div class="result-details">
          Accuracy: ${percentage}% | Time: ${Math.floor(secondsElapsed/60)}:${(secondsElapsed%60).toString().padStart(2,'0')}
        </div>
        <button type="button" class="btn-primary" onclick="tryAnotherQuiz()">
          <i class="fas fa-redo"></i>
          Try Another Quiz
        </button>
      `;
      
      resultDiv.style.display = "block";
      resultDiv.classList.add('fade-in');
      
      displayRankingsFromSheets(currentResult);
      
      // Refresh dropdowns to show updated quiz availability
      setTimeout(async () => {
        if (classSelect.value && subjectSelect.value && testTypeSelect.value) {
          if (testTypeSelect.value === 'chapterwise') {
            await populateChapterDropdown();
          } else if (testTypeSelect.value === 'midterm1' || testTypeSelect.value === 'midterm2') {
            await populateMidtermTestDropdown();
          }
          await updateQuizStatsBanner();
        }
      }, 2000);
      
      // Update ticker after quiz completion
      setTimeout(() => {
        loadInitialTicker();
      }, 1500);
      sendFormspreeResult(score, currentQuiz.questions.length, currentQuiz.title, secondsElapsed);
      
      // Scroll to results
      resultDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    function sendFormspreeResult(score, total, quizTitleStr, timeInSeconds) {
      const data = {
        name: currentStudentName,
        mobile: currentStudentMobile,
        quiz: quizTitleStr,
        score: `${score} / ${total}`,
        time: `${Math.floor(timeInSeconds/60)}:${(timeInSeconds%60).toString().padStart(2,'0')}`
      };
      
      fetch('https://formspree.io/f/xrbkjvky', {
        method: "POST",
        headers: { 'Accept': 'application/json', 'Content-Type': 'application/json' },
        body: JSON.stringify({
          name: data.name,
          mobile: data.mobile,
          quiz: data.quiz,
          score: data.score,
          time: data.time,
          message: `Quiz: ${data.quiz}\nName: ${data.name}\nMobile: ${data.mobile}\nScore: ${data.score}\nTime: ${data.time}`
        })
      }).catch(error => console.log('Formspree error:', error));
    }

    // Event listeners
    classSelect.onchange = async () => {
      await populateSubjectDropdown();
      checkSelectionsComplete();
    };
    
    subjectSelect.onchange = () => {
      const subjectVal = subjectSelect.value;
      if (!subjectVal) {
        testTypeDropdownGroup.style.display = 'none';
        testTypeSelect.value = '';
        chapterDropdownContainer.style.display = 'none';
        midtermDropdownContainer.style.display = 'none';
        startQuizButtonContainer.style.display = 'none';
        quizArea.style.display = 'none';
        return;
      }
      
      // Show test type dropdown
      testTypeDropdownGroup.style.display = 'block';
      testTypeSelect.value = '';
      chapterDropdownContainer.style.display = 'none';
      midtermDropdownContainer.style.display = 'none';
      startQuizButtonContainer.style.display = 'none';
      quizArea.style.display = 'none';
      checkSelectionsComplete();
    };
    
    testTypeSelect.onchange = () => {
      handleTestTypeChange();
      checkSelectionsComplete();
    };
    
    chapterSelect.onchange = () => {
      checkSelectionsComplete();
    };
    
    midtermTestSelect.onchange = () => {
      checkSelectionsComplete();
    };
    
    // Start Quiz button click handler
    const startQuizBtn = document.getElementById('startQuizBtn');
    if (startQuizBtn) {
      startQuizBtn.addEventListener('click', showQuiz);
    }

    // Initialize
    function initializeQuiz() {
      // Only initialize if elements exist
      if (dropdownsDiv) {
        dropdownsDiv.style.display = "none";
      }
      if (quizArea) {
        quizArea.style.display = "none";
      }
      if (subjectDropdownGroup) {
        subjectDropdownGroup.style.display = 'none';
      }
      if (testTypeDropdownGroup) {
        testTypeDropdownGroup.style.display = 'none';
      }
      if (chapterDropdownContainer) {
        chapterDropdownContainer.style.display = 'none';
      }
      if (midtermDropdownContainer) {
        midtermDropdownContainer.style.display = 'none';
      }
      if (startQuizButtonContainer) {
        startQuizButtonContainer.style.display = 'none';
      }
      
      // Populate class dropdown
      if (classSelect) {
        populateClassDropdown();
      }
      
      // Load initial ticker
      loadInitialTicker();
      
      // Check and show notification banner
      checkAndShowNotificationBanner();
      
      // Schedule daily notifications
      scheduleDailyNotifications();
    }

    // Multiple initialization attempts
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => setTimeout(initializeQuiz, 100));
    } else {
      setTimeout(initializeQuiz, 100);
    }
    window.addEventListener('load', () => setTimeout(initializeQuiz, 200));
  </script>
</body>
</html>
