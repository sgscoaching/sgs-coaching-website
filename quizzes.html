<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SGS Coaching | Interactive Quiz Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <!-- ...[CSS unchanged, omitted for brevity]... -->
</head>
<body>
  <!-- ...[HTML unchanged, omitted for brevity]... -->

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getFirestore, collection, addDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";
    // import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-analytics.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA6AV3NbucOhGYe6N7LVzMSgfNyKR-9ULA",
      authDomain: "sgsresults-f070e.firebaseapp.com",
      projectId: "sgsresults-f070e",
      storageBucket: "sgsresults-f070e.firebasestorage.app",
      messagingSenderId: "184208947221",
      appId: "1:184208947221:web:0c730557ce4b0b3a28b61c",
      measurementId: "G-YB538BQEDG"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Global variables
    let currentStudentName = "";
    let currentStudentMobile = "";
    let currentQuiz = null;
    let quizStartTime = null;
    let quizTimer = null;
    let secondsElapsed = 0;
    let answeredQuestions = 0;

    // DOM elements
    const infoForm = document.getElementById('studentInfoForm');
    const infoError = document.getElementById('infoError');
    const dropdownsDiv = document.querySelector('.dropdowns');
    const classSelect = document.getElementById('classSelect');
    const subjectSelect = document.getElementById('subjectSelect');
    const chapterSelect = document.getElementById('chapterSelect');
    const quizArea = document.getElementById('quizArea');
    const quizForm = document.getElementById('quizForm');
    const quizTitle = document.getElementById('quizTitle');
    const resultDiv = document.getElementById('result');
    const timeDisplay = document.getElementById('timeDisplay');
    const rankingSection = document.getElementById('rankingSection');
    const userRank = document.getElementById('userRank');
    const topRankersDiv = document.getElementById('topRankers');
    const progressBar = document.getElementById('progressBar');
    const floatingStats = document.getElementById('floatingStats');

    // Form handler & utility functions remain unchanged...

    // Ranking functions
    function getQuizKey() {
      return `${currentQuiz.title}_${classSelect.value}_${subjectSelect.value}`;
    }

    // Save quiz result to Firestore
    async function saveQuizResult(score, totalQuestions, timeInSeconds) {
      const quizKey = getQuizKey();
      const result = {
        name: currentStudentName,
        mobile: currentStudentMobile,
        score: score,
        total: totalQuestions,
        time: timeInSeconds,
        timestamp: Date.now(),
        quizKey: quizKey
      };
      try {
        await addDoc(collection(db, "quizResults"), result);
      } catch (err) {
        console.error("Error saving result to Firebase:", err);
      }
      return result;
    }

    // Fetch results from Firestore and calculate rank
    async function calculateRankings(currentResult) {
      const quizKey = getQuizKey();
      let quizResults = [];
      try {
        const q = query(collection(db, "quizResults"), where("quizKey", "==", quizKey));
        const snapshot = await getDocs(q);
        snapshot.forEach(doc => {
          quizResults.push(doc.data());
        });
      } catch (err) {
        console.error("Error fetching results from Firebase:", err);
      }
      quizResults.sort((a, b) => {
        if (b.score !== a.score) return b.score - a.score;
        return a.time - b.time;
      });
      const userRankNum = quizResults.findIndex(r =>
        r.name === currentResult.name &&
        r.mobile === currentResult.mobile &&
        r.timestamp === currentResult.timestamp
      ) + 1;
      return {
        userRankNum,
        topRankers: quizResults.slice(0, 5),
        quizResults
      };
    }

    // Display rankings
    async function displayRankings(currentResult) {
      const { userRankNum, topRankers } = await calculateRankings(currentResult);
      userRank.innerHTML = userRankNum > 0
        ? `<div class="rank-number">#${userRankNum}</div>
           <div style="color: #92400e; font-weight: 600; font-size: 1.1rem;">Your Rank</div>
           <div style="color: #78716c; margin-top: 0.5rem;">
             Score: ${currentResult.score}/${currentResult.total} |
             Time: ${Math.floor(currentResult.time/60)}:${(currentResult.time%60).toString().padStart(2,'0')}
           </div>`
        : "<div>Rank not found</div>";

      topRankersDiv.innerHTML = '';
      if (topRankers.length === 0) {
        topRankersDiv.innerHTML = '<div style="text-align: center; color: #92400e;">No previous results</div>';
      } else {
        topRankers.forEach((result, index) => {
          const rankClass = index === 0 ? 'gold' : index === 1 ? 'silver' : index === 2 ? 'bronze' : '';
          const medal = index === 0 ? 'ðŸ¥‡' : index === 1 ? 'ðŸ¥ˆ' : index === 2 ? 'ðŸ¥‰' : '';
          const percentage = Math.round((result.score / result.total) * 100);
          const rankItem = document.createElement('div');
          rankItem.className = `rank-item ${rankClass}`;
          rankItem.innerHTML = `
            <div>
              <strong>${medal} ${result.name}</strong><br>
              <small style="color: #6b7280;">${result.score}/${result.total} (${percentage}%) | ${Math.floor(result.time/60)}:${(result.time%60).toString().padStart(2,'0')}</small>
            </div>
            <div style="font-weight: bold; color: #92400e;">#${index + 1}</div>
          `;
          topRankersDiv.appendChild(rankItem);
        });
      }

      rankingSection.style.display = 'block';
      rankingSection.classList.add('fade-in');
    }

    // Update checkAnswers to use async displayRankings
    async function checkAnswers() {
      stopTimer();
      let score = 0;
      currentQuiz.questions.forEach((q, idx) => {
        const options = document.querySelectorAll(`input[name="q${idx}"]`);
        const selected = document.querySelector(`input[name="q${idx}"]:checked`);
        options.forEach(option => {
          const optionItem = option.closest('.option-item');
          optionItem.classList.remove('selected');
          if (option.value === q.answer) {
            optionItem.classList.add('correct');
          }
          if (selected && option === selected && option.value !== q.answer) {
            optionItem.classList.add('wrong');
          }
        });
        if (selected && selected.value === q.answer) score++;
      });
      const currentResult = await saveQuizResult(score, currentQuiz.questions.length, secondsElapsed);
      const percentage = Math.round((score / currentQuiz.questions.length) * 100);
      resultDiv.innerHTML = `
        <div class="result-score">${score}/${currentQuiz.questions.length}</div>
        <div class="result-details">
          Accuracy: ${percentage}% | Time: ${Math.floor(secondsElapsed/60)}:${(secondsElapsed%60).toString().padStart(2,'0')}
        </div>
        <button type="button" class="btn-primary" onclick="tryAnotherQuiz()">
          <i class="fas fa-redo"></i>
          Try Another Quiz
        </button>
      `;
      resultDiv.style.display = "block";
      resultDiv.classList.add('fade-in');
      await displayRankings(currentResult);
      resultDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    // ...[Other quiz logic remains unchanged]...
  </script>
</body>
</html>
